<!DOCTYPE html>
<html lang="en-GB" color-mode="light" sound-mode="sound">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>GitOps — Project | Kai Chevannes</title>
    <meta name="description" content="Portfolio" />

    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" href="/_css/base.css" />
    <link rel="stylesheet" href="/_css/components.css" />
    <link rel="stylesheet" href="/_css/utilities.css" />

    <script>
      if (
        localStorage.getItem("color-mode") === "dark" ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches &&
          !localStorage.getItem("color-mode"))
      ) {
        document.documentElement.setAttribute("color-mode", "dark");
      }
      if (localStorage.getItem("sound-mode") === "muted") {
        document.documentElement.setAttribute("sound-mode", "muted");
      }
      document.documentElement.setAttribute("playing-mode", "playing");
    </script>
  </head>

  <body>
    <div class="max-width-wrapper">
      <header class="header">
        <div class="header__frosted-glass"></div>
        <a class="header__title" href="/">
          kai chevannes<span class="accent">.</span>
        </a>
        <div class="header__spacer">
          <div
            class="header__lightbulb slide-in"
            style="
              --offset: -80px;
              --duration: 1300ms;
              --ease-function: var(--spring-easing);
            "
          >
            <div class="header__lightbulb-cord"></div>
            <!-- Light mode lightbulb inner -->
            <svg
              class="header__lightbulb-inner light-mode-only"
              style="color: var(--color-highlight)"
            >
              <use href="/_assets/svgs/lightbulb-inner.svg#lightbulb-inner" />
            </svg>
            <!-- Dark mode lightbulb inner -->
            <svg
              class="header__lightbulb-inner dark-mode-only"
              style="color: transparent"
            >
              <use href="/_assets/svgs/lightbulb-inner.svg#lightbulb-inner" />
            </svg>
            <svg class="header__lightbulb-outer">
              <use href="/_assets/svgs/lightbulb.svg#lightbulb" />
            </svg>
          </div>
        </div>
        <nav class="header__nav">
          <a href="/#about" class="header__nav-link">about</a>
          <a href="/#projects" class="header__nav-link">projects</a>
          <a href="/#contact" class="header__nav-link">contact</a>
        </nav>
        <div class="header__spacer"></div>
        <div class="header__buttons">
          <!-- Sound button -->
          <button
            class="header__button slide-in sound-on-only"
            onclick="setSoundMode('muted');"
          >
            <svg class="header__icon">
              <use href="/_assets/svgs/volume-2.svg#volume-2" />
            </svg>
            sound
          </button>

          <!-- Muted button -->
          <button
            class="header__button slide-in sound-muted-only"
            onclick="setSoundMode('sound');"
          >
            <svg class="header__icon">
              <use href="/_assets/svgs/volume-x.svg#volume-x" />
            </svg>
            muted
          </button>

          <!-- Light mode button -->
          <audio
            id="sound-lightoff"
            src="/_assets/sounds/lightoff.mp3"
            preload="auto"
          ></audio>
          <button
            class="header__button slide-in light-mode-only"
            style="--delay: 300ms"
            onclick="setColorMode('dark'); playLightOff();"
          >
            <svg class="header__icon">
              <use href="/_assets/svgs/sun.svg#sun" />
            </svg>
            light
          </button>

          <!-- Dark mode button -->
          <audio
            id="sound-lighton"
            src="/_assets/sounds/lighton.mp3"
            preload="auto"
          ></audio>
          <button
            class="header__button slide-in dark-mode-only"
            style="--delay: 300ms"
            onclick="setColorMode('light'); playLightOn();"
          >
            <svg class="header__icon">
              <use href="/_assets/svgs/moon.svg#moon" />
            </svg>
            dark
          </button>
        </div>
        <button
          class="header__button header__button--mobile slide-in"
          onclick="openMobileDialog()"
        >
          <svg class="header__icon header__icon--mobile">
            <use href="/_assets/svgs/menu.svg#menu" />
          </svg>
        </button>
        <dialog id="mobile-dialog" class="header__mobile-dialog">
          <nav class="header__mobile-nav">
            <a href="/#about" class="header__nav-link header__nav-link--mobile"
              >about</a
            >
            <a
              href="/#projects"
              class="header__nav-link header__nav-link--mobile"
              >projects</a
            >
            <a
              href="/#contact"
              class="header__nav-link header__nav-link--mobile"
              >contact</a
            >
          </nav>
          <div class="header__mobile-buttons">
            <div>
              <!-- Light mode button -->
              <audio
                id="sound-lightoff"
                src="/_assets/sounds/lightoff.mp3"
                preload="auto"
              ></audio>
              <button
                class="header__button header__button--mobile header__button--mobile-menu light-mode-only"
                onclick="setColorMode('dark'); playLightOff();"
              >
                <svg class="header__icon header__icon--mobile">
                  <use href="/_assets/svgs/sun.svg#sun" />
                </svg>
                light
              </button>

              <!-- Dark mode button -->
              <audio
                id="sound-lighton"
                src="/_assets/sounds/lighton.mp3"
                preload="auto"
              ></audio>
              <button
                class="header__button header__button--mobile header__button--mobile-menu dark-mode-only"
                onclick="setColorMode('light'); playLightOn();"
              >
                <svg class="header__icon header__icon--mobile">
                  <use href="/_assets/svgs/moon.svg#moon" />
                </svg>
                dark
              </button>
            </div>
            <div>
              <!-- Sound button -->
              <button
                class="header__button header__button--mobile header__button--mobile-menu sound-on-only"
                onclick="setSoundMode('muted');"
              >
                <svg class="header__icon header__icon--mobile">
                  <use href="/_assets/svgs/volume-2.svg#volume-2" />
                </svg>
                sound
              </button>

              <!-- Muted button -->
              <button
                class="header__button header__button--mobile header__button--mobile-menu sound-muted-only"
                onclick="setSoundMode('sound');"
              >
                <svg class="header__icon header__icon--mobile">
                  <use href="/_assets/svgs/volume-x.svg#volume-x" />
                </svg>
                muted
              </button>
            </div>
          </div>
          <button
            class="header__button header__button--mobile header__button--close"
            onclick="closeMobileDialog()"
          >
            <svg class="header__icon header__icon--mobile">
              <use href="/_assets/svgs/x.svg#x" />
            </svg>
          </button>
        </dialog>
      </header>
      <main class="project">
        <div class="project__page-title">
          <div class="project__details">
            <h1 class="project__title">GitOps</h1>
            <p class="project__description">
              Self-hosted, zero-downtime Kubernetes… and why I ditched it nine
              months later.
            </p>
          </div>
          <figure>
            <figcaption class="project__key-technologies">
              Key Technologies
            </figcaption>
            <div class="project__tech">
              <div class="project__tech-entry">
                <svg class="project__icon project__icon--oracle">
                  <use href="/_assets/svgs/oracle-cloud.svg#oracle-cloud" />
                </svg>
                <p class="project__tech-text">Oracle Cloud</p>
              </div>
              <div class="project__tech-entry">
                <svg class="project__icon">
                  <use href="/_assets/svgs/ansible.svg#ansible" />
                </svg>
                <p class="project__tech-text">Ansible</p>
              </div>
              <div class="project__tech-entry">
                <svg class="project__icon">
                  <use href="/_assets/svgs/kubernetes.svg#kubernetes" />
                </svg>
                <p class="project__tech-text">Kubernetes</p>
              </div>
              <div class="project__tech-entry">
                <svg class="project__icon">
                  <use href="/_assets/svgs/flux.svg#flux" />
                </svg>
                <p class="project__tech-text">Flux</p>
              </div>
            </div>
          </figure>
        </div>
        <figure>
          <div class="project__video-wrapper">
            <video
              id="video"
              class="project__video"
              playsinline
              autoplay
              loop
              muted
              preload="auto"
            >
              <source src="/_assets/videos/cluster-bootstrap.webm" />
              <source src="/_assets/videos/cluster-bootstrap.mp4" />
            </video>
            <button
              class="project__video-button playing-only"
              onclick="setPlaying(false)"
            >
              <svg class="project__video-button-icon">
                <use href="/_assets/svgs/pause.svg#pause" />
              </svg>
            </button>
            <button
              class="project__video-button paused-only"
              onclick="setPlaying(true)"
            >
              <svg class="project__video-button-icon">
                <use href="/_assets/svgs/play.svg#play" />
              </svg>
            </button>
          </div>
          <figcaption class="project__caption project__caption--video">
            Figure 1: Bootstrapping the VM with Ansible
          </figcaption>
        </figure>
        <section id="preface" class="project__section">
          <h2 class="project__section-title">Preface</h2>
          <p class="project__section-content">
            Nine months after this writeup I found out that my website SSL
            certificate had, for some reason or other, become invalid. I also
            found out that I couldn't recall how and where I got that working to
            begin with, and that the OAuth token for my backend email service
            failed to auto-renew, so my contact form was also broken. Afraid to
            peer into the depths of my own creation, I did what any
            self-respecting developer would do in my shoes: I rewrote the entire
            website from the ground up. My concluding thoughts follow the
            original writeup.
          </p>
        </section>
        <svg class="project__icon--bleed">
          <use href="/_assets/svgs/preface-squiggly.svg#preface-squiggly" />
        </svg>
        <section class="project__section">
          <h2 class="project__section-title">Summary</h2>
          <p class="project__section-content">
            I set up a
            <span class="tooltip"
              >CI/CD<span class="tooltiptext"
                ><strong>Continuous Integration</strong> /
                <strong>Continuous Deployment</strong> automates testing and
                releases.</span
              ></span
            >
            pipeline using GitHub Actions to automate site updates. On each
            merge to <code>main</code> it follows the
            <span class="tooltip"
              >Docker<span class="tooltiptext"
                >A tool for creating <strong>containers</strong>: mini operating
                systems that have instructions for how to install and run an
                application, so apps run identically anywhere Docker is
                installed.</span
              ></span
            >
            <strong class="semibold">build</strong> →
            <strong class="semibold">ship</strong> →
            <strong class="semibold">run</strong> methodology:
          </p>
          <ol class="project__section-content">
            <li>
              <strong class="semibold">Build</strong> a Docker image of the site
            </li>
            <li>
              <strong class="semibold">Ship</strong> the image to GitHub's
              Container Registery
            </li>
            <li>
              <strong class="semibold">Run</strong> the image on my always-free
              Oracle Cloud
              <span class="tooltip"
                >VM<span class="tooltiptext"
                  ><strong>Virtual Machine</strong></span
                ></span
              >
            </li>
          </ol>
          <p class="project__section-content">
            I bootstrap the VM with
            <span class="tooltip"
              >Ansible<span class="tooltiptext"
                >An <strong>Infrastructure as Code</strong> tool used to
                configure virtual machines post-provisioning.</span
              ></span
            >, setting up
            <span class="tooltip"
              >Kubernetes<span class="tooltiptext"
                >A <strong>container orchestrator</strong> that automates the
                deployment, scaling and rolling updates of containers.</span
              ></span
            >
            and
            <span class="tooltip"
              >Flux<span class="tooltiptext"
                >A <strong>GitOps</strong> CD tool.</span
              ></span
            >
            seen in Figure 1. Flux watches the portfolio's
            <a class="link" href="https://github.com/kaichevannes/portfolio"
              >Git repository</a
            >
            and syncs the cluster with its state.
          </p>
        </section>
        <section class="project__section">
          <h2 class="project__section-title">Purpose & Goal</h2>
          <p class="project__section-content">
            I became interested in
            <span class="tooltip"
              >DevOps<span class="tooltiptext"
                >A software development approach that follows
                <em>the three ways</em>: increasing left to right flow of work,
                increasing right to left flow of feedback, cultivating a culture
                of continuous experimentation and learning.</span
              ></span
            >
            after reading <em>The Phoenix Project</em> during my 2023 summer
            internship at Thought Quarter. I saw this project as an opportunity
            to imporve my mental model of CI/CD technologies and Docker. My
            acceptance criteria were:
          </p>
          <ol class="project__section-content">
            <li>
              <strong class="semibold">One-click</strong> cluster bootstrap
            </li>
            <li><strong class="semibold">One-click</strong> deploy</li>
            <li>
              <strong class="semibold">Zero-downtime</strong> rolling updates
            </li>
          </ol>
          <p class="project__section-content">
            To build a foundation, I completed
            <a
              class="link"
              href="https://www.udemy.com/certificate/UC-c44e8380-3f04-4ec5-9ba1-79e84fdadc8e/"
              >Docker Mastery</a
            >
            and
            <a
              class="link"
              href="https://www.udemy.com/certificate/UC-64b4f7e8-f42d-4f9a-88db-fc2634b40f90/"
              >Kubernetes Mastery</a
            >
            by Bret Fisher on Udemy.
          </p>
        </section>
        <section class="project__section">
          <h2 class="project__section-title">Spotlight</h2>
          <p class="project__section-content">
            GitOps changes the <strong class="semibold">run</strong> stage of
            <strong class="semibold">build</strong>
            → <strong class="semibold">ship</strong> →
            <strong class="semibold">run</strong>. Instead of
            <em>pushing</em> changes to a Kubernetes cluster using a secret key,
            GitOps <em>pulls</em> the changes from source control. This
            eliminates the need to store high-privilege access keys, improving
            security. Figure 2 shows the Kubernetes
            <span class="tooltip"
              >manifest<span class="tooltiptext"
                >YAML files that store the declarative state of the
                cluster.</span
              ></span
            >
            files that Flux syncs the cluster state with.
          </p>
          <figure class="full-bleed">
            <img
              class="project__section-image"
              src="/_assets/images/manifest-files.webp"
              alt="A screenshot of the portfolio GitHub repo showing a list of YAML manifest files."
            />
            <figcaption class="project__caption">
              Figure 2: Kubernetes manifest files
            </figcaption>
          </figure>
          <p class="project__section-content">
            One of the key benefits of GitOps is that because we store the
            cluster state in code, rolling back releases is the same as rolling
            back code. My CI/CD pipeline updates the deployment to the current
            commit hash which Flux detects and applies to the cluster with a
            Kubernetes rolling update.
          </p>
          <figure class="full-bleed">
            <img
              class="project__section-image"
              src="/_assets/images/image-tag.webp"
              alt="A screenshot of the portfolio GitHub repo showing the portfolio-deployment.yaml file. A highlighted line shows the image hash of the current version."
            />
            <figcaption class="project__caption">
              Figure 3: The image tag for the current release is set to the
              latest commit hash
            </figcaption>
          </figure>
        </section>
        <section class="project__section">
          <h2 class="project__section-title">Challenges</h2>
          <p class="project__section-content">
            The biggest challenge in self-hosting my portfolio was the
            networking. To serve a request from a user that types
            <em>kaichevannes.com</em> into their browser, I need to:
          </p>
          <ol class="project__section-content">
            <li>
              <strong class="semibold">Allow</strong> incoming traffic on HTTP
              and HTTPS to my Oracle Cloud VM through its ingress rules
            </li>
            <li>
              <strong class="semibold">Route</strong> incoming requests to
              <span class="tooltip"
                >Traefik<span class="tooltiptext"
                  >A cloud native reverse proxy similar to nginx, designed for
                  use with containers.</span
                ></span
              >, running on my Kubernetes cluster
            </li>
            <li>
              <strong class="semibold">Provide</strong> Traefik with the
              credentials to complete an
              <span class="tooltip"
                >ACME<span class="tooltiptext"
                  ><strong>Automatic Certificate Management Environment</strong>
                  protocol. It automates the retrieval and renewal of the TLS
                  certificates we need to serve requests over HTTPS.</span
                ></span
              >
              DNS challenge with my domain registrar
            </li>
            <li>
              <strong class="semibold">Persist</strong> the TLS certificate to
              avoid Let's Encrypt rate limits
            </li>
            <li>
              <strong class="semibold">Redirect</strong> HTTP requests to HTTPS
              requests using a Kubernetes Ingress resource
            </li>
            <li>
              <strong class="semibold">Forward</strong> HTTPS requests to
              <span class="tooltip"
                >Next.js<span class="tooltiptext"
                  >A full-stack <strong>meta-framework</strong> built on top of
                  React.</span
                ></span
              >
            </li>
          </ol>
          <p class="project__section-content">
            In step 3, I need to provide Traefik with a secret API token for
            authentication. In declarative methodologies like GitOps this
            presents a challenge because the full cluster state is kept in
            source control.
          </p>
          <p class="project__section-content">
            In enterprise, your Kubernetes cluster is usually hosted with a
            cloud provider that has a built-in secret manager like
            <span class="tooltip"
              >AWS<span class="tooltiptext"
                ><strong>Amazon Web Services</strong></span
              ></span
            >
            or
            <span class="tooltip"
              >Azure<span class="tooltiptext"
                ><strong>Microsoft Azure</strong></span
              ></span
            >. Because I'm running a
            <span class="tooltip"
              >K3s<span class="tooltiptext"
                >A minimal <strong>Kubernetes distribution</strong> built for
                environments with limited resources.</span
              ></span
            >
            cluster on a VM, I need to handle secrets myself.
          </p>
          <p class="project__section-content">
            I use
            <a
              class="link"
              href="https://github.com/bitnami-labs/sealed-secrets"
              >Bitnami Sealed Secrets</a
            >
            which generates a public/private key pair inside the cluster. I can
            encrypt the secret API token using the clusters public key and
            safely store it in source control. The private key to decrypt this
            secret only exists within the cluster.
          </p>
        </section>
        <section class="project__section">
          <h2 class="project__section-title">Lessons Learned</h2>
          <p class="project__section-content">
            This project taught me to slow down and and make less assumptions.
            For example, when configuring Traefik locally I used the built-in
            Kubernetes <em>Ingress</em> resource, but the documentation for
            certificate verfication used a custom
            <em>IngressRoute</em> resource. I didn't think this woud change
            anything so I skipped locally testing it and this led me down a
            rabbithole of attempting to fix what I thought was a networking
            issue for my broken deployment…
          </p>
          <p class="project__section-content">
            I tried changing my cluster configuration only to break my bootstrap
            script, linking Traefik directly to my VM's network using Kubernetes
            hostports, forwarding requests using custom iptables rules, swapping
            the networking backend of my cluster. I read the docs more
            thoroughly and realised it wasn't a networking issue but the
            configuration of the
            <em>IngressRoute</em> resource that I assumed would switch out one
            for one with my local <em>Ingress</em> resource.
          </p>
          <p class="project__section-content">
            I gained a better appreciation for documentation because the issues
            I was running into were difficult to Google. I also improved my
            understanding of working iteratively in small batch sizes; trying to
            put so many pieces together in one go led to such a large surface
            area for problems that I eventually had to take it step by step
            anyway. Next time, I'll start that way.
          </p>
        </section>
        <svg class="project__icon--bleed">
          <use
            href="/_assets/svgs/postscript-squiggly.svg#postscript-squiggly"
          />
        </svg>
        <section class="project__section">
          <h2 class="project__section-title">Postscript</h2>
          <p class="project__section-content">
            While I'm happy that I maximised the complexity of frameworks and
            meta-frameworks and self-hosting and Docker and Kubernetes and
            zero-downtime for learning purposes, I did unfortunately end up with
            a system so devilishly complicated that I could no longer interact
            with it half a year later. For the rewrite, I went to the other
            extreme: vanilla HTML, vanilla CSS, vanilla JavaScript. The holy
            trinity.
          </p>
          <p class="project__section-content">
            It was a fun rewrite, there were so many barriers I ran into while
            developing the original that I blew past this time. I also
            simplified the code while retaining all functionality, and added
            some enhancements like animations for tooltips closing. Simple
            things like dark mode become exceedingly complicated when you're
            working with
            <span class="tooltip"
              ><strong class="semibold">SSR</strong
              ><span class="tooltiptext"
                ><strong>Server Side Rendering</strong></span
              ></span
            >, <strong class="semibold">hydration</strong>, and —
            <em>shudders</em> — <strong class="semibold">Webpack</strong>. I
            realised that the real value of these frameworks is for sites that
            need to handle a lot of dynamic content like in e-commerce, or that
            are very interactive like web apps. For anything static, the basics
            really are the best tool.
          </p>
        </section>
        <nav class="project__nav">
          <a
            class="project__nav-link project__nav-link--disabled"
            aria-disabled="true"
            tabindex="-1"
            >←</a
          >
          <a class="project__nav-link" href="/boids">Web Boids →</a>
        </nav>
      </main>
      <footer class="footer">
        <div class="footer__icons">
          <a href="https://wave.webaim.org/" class="footer__link">
            <svg class="footer__icon footer__icon--wave">
              <use href="/_assets/svgs/wave.svg#wave" />
            </svg>
            Wave
          </a>
          <a href="https://www.deque.com/" class="footer__link">
            <svg class="footer__icon footer__icon--axe">
              <use href="/_assets/svgs/axe.svg#axe" />
            </svg>
            Axe Deque
          </a>
          <a href="https://accessibilityinsights.io/" class="footer__link">
            <svg class="footer__icon">
              <use href="/_assets/svgs/a11yinsights.svg#a11yinsights" />
            </svg>
            A11y Insights
          </a>
        </div>
        <div class="footer__icons">
          <a
            href="https://www.linkedin.com/in/kaichevannes/"
            class="footer__link"
          >
            <svg class="footer__icon">
              <use href="/_assets/svgs/linkedin.svg#linkedin" />
            </svg>
            LinkedIn
          </a>
          <a href="https://github.com/kaichevannes" class="footer__link">
            <svg class="footer__icon footer__icon--github">
              <use href="/_assets/svgs/github.svg#github" />
            </svg>
            GitHub
          </a>
        </div>
      </footer>
    </div>

    <script src="/_js/main.js" defer></script>
    <script>
      function setPlaying(play) {
        const video = document.querySelector("#video");

        if (play) {
          video.play();
          document.documentElement.setAttribute("playing-mode", "playing");
        } else {
          video.pause();
          document.documentElement.setAttribute("playing-mode", "paused");
        }
      }
    </script>
  </body>
</html>
